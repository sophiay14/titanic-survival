---
format: html
execute: 
  echo: false
---

```{r}
#| label: setup
#| include: false
library(tidyverse)
library(titanic)
library(broom)

# Load + clean dataset
data <- titanic_train |> 
  select(Survived, Pclass, Sex, Age) |> 
  drop_na() |>
  mutate(
    Survived = factor(Survived, levels = c(0,1), labels = c("Died","Survived")),
    Pclass = factor(Pclass),
    Sex = factor(Sex)
  )

# Train/test split
set.seed(123)
train_idx <- sample(1:nrow(data), size = 0.8 * nrow(data))
train <- data[train_idx, ]
test <- data[-train_idx, ]

# Logistic regression model
model <- glm(Survived ~ Pclass + Sex + Age, data = train, family = "binomial")
coeffs <- tidy(model, exponentiate = TRUE, conf.int = TRUE)
```

# Survival by Gender

```{r}
ggplot(data, aes(x = Sex, fill = Survived)) +
  geom_bar(position = "fill") +
  labs(y = "Proportion") +
  scale_fill_manual(values = c("red","green"))
```

# Survival by Class

```{r}
ggplot(data, aes(x = Pclass, fill = Survived)) +
  geom_bar(position = "fill") +
  labs(y = "Proportion") +
  scale_fill_manual(values = c("red","green"))
```

# Gender and Class Interaction

```{r}
# Raw proportions
ggplot(data, aes(x = Pclass, fill = Survived)) +
  geom_bar(position = "fill") +
  facet_wrap(~Sex) +
  labs(title = "Observed Survival by Gender and Class", y = "Proportion")

# Model predictions
newdata <- expand.grid(
  Pclass = factor(1:3),
  Sex = factor(c("male","female")),
  Age = median(data$Age, na.rm = TRUE)
)
newdata$pred <- predict(model, newdata, type = "response")

ggplot(newdata, aes(x = Pclass, y = pred, fill = Sex)) +
  geom_col(position = "dodge") +
  labs(title = "Predicted Survival Probability by Gender and Class",
       y = "Predicted Probability")
```

# Age Distribution

```{r}
# Raw data distribution
ggplot(data, aes(x = Age, fill = Survived)) +
  geom_histogram(bins = 30, alpha = 0.6, position = "identity") +
  labs(title = "Observed Age Distribution by Survival")

# Model-predicted curve
newdata_age <- expand.grid(
  Pclass = factor(1:3),
  Sex = factor(c("male","female")),
  Age = seq(1, 80, by = 1)
)
newdata_age$pred <- predict(model, newdata_age, type = "response")

ggplot(newdata_age, aes(x = Age, y = pred, color = Sex)) +
  geom_line(linewidth = 1) +
  facet_wrap(~Pclass) +
  labs(title = "Predicted Survival Probability by Age, Sex, and Class",
       y = "Predicted Probability")
```

# Age v. Survival

```{r}
# Raw data boxplot
ggplot(data, aes(x = Survived, y = Age, fill = Survived)) +
  geom_boxplot() +
  labs(title = "Observed Age Distribution by Survival")

# Model-implied survival probability (logistic curve overlay)
ggplot(data, aes(x = Age, y = as.numeric(Survived)-1)) +
  geom_jitter(alpha = 0.2, height = 0.05) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  labs(title = "Logistic Curve of Survival by Age",
       y = "Survival Probability")
```
