---
format: html
execute: 
  echo: false
  warning: false
---

```{r}
#| label: setup
#| include: false
library(tidyverse)
library(titanic)
library(broom)

# Load + clean dataset
data <- titanic_train |> 
  select(Survived, Pclass, Sex, Age) |> 
  drop_na() |>
  mutate(
    Survived = factor(Survived, levels = c(0,1), labels = c("Died","Survived")),
    Pclass = factor(Pclass),
    Sex = factor(Sex)
  )

# Train/test split
set.seed(123)
train_idx <- sample(1:nrow(data), size = 0.8 * nrow(data))
train <- data[train_idx, ]
test <- data[-train_idx, ]

# Logistic regression model
model <- glm(Survived ~ Pclass + Sex + Age, data = train, family = "binomial")
coeffs <- tidy(model, exponentiate = TRUE, conf.int = TRUE)
```

This report presents an analysis of survival outcomes from the Titanic dataset using logistic regression and data visualization.  
The study evaluates the influence of passenger class, gender, and age on survival probabilities. Results indicate that survival was strongly associated with gender and class: women and first-class passengers had substantially higher survival rates, while men and third-class passengers faced markedly lower odds. Age also played a significant role, with survival probability decreasing steadily as age increased. The logistic regression model quantifies these relationships, providing a clear statistical framework for understanding the factors that shaped survival on the Titanic.

# Survival by Gender

```{r}
#| fig-cap: "Proportion of survival outcomes by gender."
ggplot(data, aes(x = Sex, fill = Survived)) +
  geom_bar(position = "fill") +
  labs(y = "Proportion") +
  scale_fill_manual(values = c("#e74c3c","#27ae60")) +
  theme(legend.position = "bottom")
```

# Survival by Class

```{r}
#| fig-cap: "Proportion of survival outcomes by passenger class."
ggplot(data, aes(x = Pclass, fill = Survived)) +
  geom_bar(position = "fill") +
  labs(y = "Proportion") +
  scale_fill_manual(values = c("#e74c3c","#27ae60")) +
  theme(legend.position = "bottom")
```

# Gender and Class Interaction

```{r}
#| fig-cap: "Observed and predicted survival by gender and class."
# Observed
ggplot(data, aes(x = Pclass, fill = Survived)) +
  geom_bar(position = "fill") +
  facet_wrap(~Sex) +
  labs(title = "Observed Survival by Gender and Class", y = "Proportion") +
  scale_fill_manual(values = c("#e74c3c","#27ae60")) +
  theme(legend.position = "bottom")

# Predicted
newdata <- expand.grid(
  Pclass = factor(1:3),
  Sex = factor(c("male","female")),
  Age = median(data$Age, na.rm = TRUE)
)
newdata$pred <- predict(model, newdata, type = "response")

ggplot(newdata, aes(x = Pclass, y = pred, fill = Sex)) +
  geom_col(position = "dodge") +
  labs(title = "Predicted Survival Probability by Gender and Class",
       y = "Predicted Probability") +
  scale_fill_brewer(palette = "Set1") +
  theme(legend.position = "bottom")
```

# Age Distribution

```{r}
#| fig-cap: "Observed age distributions and predicted survival probabilities by age."
# Observed
# Observed
ggplot(data, aes(x = Age, fill = Survived)) +
  geom_histogram(bins = 30, alpha = 0.6, position = "identity") +
  labs(title = "Observed Age Distribution by Survival") +
  scale_fill_manual(values = c("#e74c3c","#27ae60")) +
  theme(legend.position = "bottom")

# Predicted
newdata_age <- expand.grid(
  Pclass = factor(1:3),
  Sex = factor(c("male","female")),
  Age = seq(1, 80, by = 1)
)
newdata_age$pred <- predict(model, newdata_age, type = "response")

ggplot(newdata_age, aes(x = Age, y = pred, color = Sex)) +
  geom_line(linewidth = 1.2) +
  facet_wrap(~Pclass) +
  labs(title = "Predicted Survival Probability by Age, Sex, and Class",
       y = "Predicted Probability") +
  scale_color_brewer(palette = "Dark2") +
  theme(legend.position = "bottom")
```
